Sentry24 DVR - isapnp или начало пути
=====================================

Ситуация знакомая почти каждому, когда то покупали плату видео наблюдения, лицензионный ключ привязывается к железу, железо со временем дохнет и о печалька, нужен новый лицензионный ключ. Такая ситуация случилась и со мной, стоял как то сервачек с платой AceCop16200B и ПО DVR Linux Sentry24, и работал тихо спокойно несколько лет, но вдруг сдохла сетевуха и счастье кончилось.

Как оказалось, ПО привязывается к сетевой карте и после замены оно тут же попросило новый ключ. Стоимость новой сетевой карточки в среднем 10-20$, а лицензия 100$, и попадать с ходу на более чем 100$ совсем не хотелось. Расковыриваем систему топорным методом "init=/bin/bash", меняем пароль на рута, перезагружаемся. Пробуем ifconfig'om сменить mac на сетевой карточке, и о боже, ПО запускается как ни в чем не бывало. Записываем пару строк перед загрузкой ПО и просим премию за экономию денег.

.. code-block:: bash

    ifconfig eth0 down;
    ifconfig eth0 hw ether 18:A9:05:89:37:4C;
    ifconfig eth0 up;

Дальше интересней. Через какое то время, пришла новая карточка AceCop04050B, был поставлен вопрос о покупке лицензии, и я решил еще раз срубить халявных денег. Работодателю было безразлично кому отдавать 100$, мне или какой либо компании, так еще если у меня получится, будет профит, в виде бесплатной возможности менять железо на видео серверах.

Первым делом взял чистую систему, поставил очередную версию ПО, благополучно слитую с официального сайта компании Emstone, начинаю рассматривать демо режим, особенного ничего не замечаю, запускаю основную программу "artnlife" через "strace" смотрим выхлоп, и видим что программа пытается найти два файла в "/boot", а именно ".masterkey" и ".stime", ну первый и понятно, там хранится лицензионный ключ, как показали вскрытия оригинальных установок, ключ там хранится в открытом виде. А вот странный файлик "/boot/.stime" сильно привлек мое внимание. В нем был набор байт невнятного содержания. Если логически мыслить, то там должна находиться временная метка, о моменте установки системы. От этой метки и идет отсчет триал периода. Следовательно надо ее научится генерировать.

Сказано, сделано! Изначально распотрошил весь устанавливаемый дистрибутив - нету. Нет вообще каках либо зацепок. Все системные файлы стандартные и сильно не отличаются, да и сторонних вызовов не было видно. Потом до меня дошло, что смысла искать в установленной системе нет. Все спрятано непосредственно в установщик!

Система установки Sentry24 проста как мир, это "initrd" образ, с shell скриптом ("<initrd>/sbin/dbootstrap"), который находит место дислокации дистрибутива(пожатого образа готовой системы), диски куда устанавливать, и бэкапер лицензии, конфигов, и метки о триал периоде! Вот почему после переустановки, с их диска триал период не продлевался. Ну и самое гадкое что делал установщик, это сбивал системное время. А также, выполнялась некая програмка "<initrd>/sbin/isapnp", которая меня даже не сразу насторожила. Ее не было в установочном образе, сугубо в "initrd". Банальным запуском было выяснено, что вот оно! Вот то что мы искали. Но желанный файлик создавался по не хорошему пути, что то вроде "/target/boot/.stime", что было в свою очередь не красибо, и не удобно для последующего использования.

Но где наша не пропадала, запускаем HEX редактор, отыскиваем стринговую таблицу, тут же меняем путь на "./.stime", и так же видим, что тут используется графический фаил, "/usr/share/artnlife/images/portrait.xpm", видимо из него по некоторой функции от даты, и берется массив байт в ключ.
